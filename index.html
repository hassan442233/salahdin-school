<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§ÙƒØªØ´Ù - Ù…Ø¯Ø±Ø³Ø© ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ© Ø§Ù„Ø®Ø§ØµØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary-color: #0288D1;
            --secondary-color: #FFC107;
            --success-color: #4CAF50;
            --error-color: #FF5252;
            --bg-color: #E1F5FE;
            --card-bg: #ffffff;
            --max-card-width: 800px;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .modal-overlay { position: fixed; top: 0; right: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: var(--card-bg); padding: 30px; border-radius: 15px; max-width: 400px; width: 90%; text-align: right; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); border: 5px solid var(--primary-color); }
        .modal-content h2 { color: var(--primary-color); margin-top: 0; font-size: 1.8rem; text-align: center; }
        .modal-content label { display: block; margin-bottom: 8px; margin-top: 15px; font-weight: bold; color: #333; }
        .modal-content input, .modal-content select { width: 100%; padding: 12px; margin-bottom: 20px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1.1rem; font-family: 'Tajawal', sans-serif; text-align: right; }
        
        .start-btn { background: var(--success-color); color: white; border: none; padding: 12px 25px; border-radius: 50px; cursor: pointer; font-size: 1.2rem; font-weight: bold; width: 100%; transition: background 0.2s; }
        .start-btn:hover { background: #388E3C; }

        /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        #main-content { display: none; width: 100%; max-width: var(--max-card-width); flex-direction: column; align-items: center; flex-grow: 1; }
        header { width: 100%; max-width: var(--max-card-width); display: flex; justify-content: space-between; align-items: center; padding: 0 5px; margin-bottom: 10px; box-sizing: border-box; }
        .school-info h1 { font-size: 1.5rem; color: var(--primary-color); margin: 0; line-height: 1.4; font-weight: 900; }
        .school-logo { height: 70px; border-radius: 10px; object-fit: contain; padding: 5px; }

        .game-container { background: var(--card-bg); width: 100%; max-width: var(--max-card-width); border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); padding: 25px; text-align: center; position: relative; border: 4px solid #fff; box-sizing: border-box; flex-grow: 1; display: flex; flex-direction: column; }
        
        .quiz-controls { display: flex; align-items: center; }
        .mute-btn { background: #f1f1f1; border: 1px solid #ccc; padding: 8px 10px; border-radius: 50%; cursor: pointer; font-size: 1.6rem; color: #555; transition: all 0.2s; width: 40px; height: 40px; line-height: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .mute-btn.muted { background: #ffcdd2; color: #c62828; border-color: #ef9a9a; }

        .progress-section { display: flex; flex-direction: column; flex-grow: 1; margin-left: 40px; margin-right: 25px; margin-bottom: 10px; }
        .progress-wrapper { display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 1.1rem; color: #555; margin-bottom: 5px; }
        .progress-container { width: 100%; background-color: #eee; border-radius: 10px; height: 15px; overflow: hidden; border: 1px solid #ddd; }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #FFEB3B, #FBC02D); transition: width 0.5s ease; border-radius: 10px; }

        .speak-btn { background: #FF9800; border: none; border-radius: 50px; padding: 10px 25px; cursor: pointer; font-size: 1rem; font-family: 'Tajawal', sans-serif; font-weight: bold; color: white; box-shadow: 0 4px 0 #F57C00; margin-bottom: 10px; transition: transform 0.1s; display: inline-flex; align-items: center; gap: 10px; }
        .speak-btn:active { transform: translateY(3px); box-shadow: none; }
        
        .question-text { font-size: 1.6rem; color: #333; margin: 10px 0 20px 0; font-weight: 900; line-height: 1.5; }
        .options-grid { display: grid; gap: 12px; width: 100%; }
        .option-btn { background: #f8f9fa; border: 2px solid #e9ecef; padding: 15px; border-radius: 15px; font-size: 1.2rem; font-family: 'Tajawal', sans-serif; font-weight: bold; cursor: pointer; transition: all 0.2s; color: #555; width: 100%; }
        .option-btn:hover { background: #e1f5fe; border-color: var(--primary-color); }
        .option-btn.correct { background-color: var(--success-color) !important; color: white !important; border-color: #388E3C !important; }
        .option-btn.wrong { background-color: var(--error-color) !important; color: white !important; border-color: #D32F2F !important; }

        .feedback-msg { margin-top: 15px; font-weight: bold; font-size: 1.1rem; min-height: 30px; }
        .end-screen { display: none; text-align: center; overflow-y: auto; max-height: 80vh; }
        .trophy { font-size: 5rem; margin-bottom: 15px; animation: bounce 2s infinite; }
        #error-summary-list div { text-align: right; }

        footer { width: 100%; max-width: var(--max-card-width); padding: 15px 0; margin-top: auto; text-align: center; }
        .footer-section { background: var(--card-bg); border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-bottom: 15px; border: 4px solid #fff; }
        .staff-grid { display: flex; gap: 15px; margin-bottom: 20px; justify-content: space-between; flex-wrap: nowrap; overflow-x: hidden; }
        .staff-member { flex: 1 1 33.33%; min-width: 150px; padding: 10px; border-radius: 10px; background-color: var(--bg-color); border: 1px solid #CFD8DC; }
        .staff-member p { margin: 0; line-height: 1.4; }
        .staff-member .title { font-weight: 400; font-size: 0.9rem; color: #607D8B; }
        .staff-member .name { font-weight: 700; color: var(--primary-color); font-size: 1.1rem; }
        .media-dept { font-size: 1rem; color: #444; font-weight: 800; margin: 0; display: flex; align-items: center; justify-content: center; gap: 8px; background: var(--secondary-color); padding: 8px 20px; border-radius: 50px; display: inline-flex; }

        @media (max-width: 650px) {
            header { flex-direction: row; gap: 5px; padding: 5px 0; }
            .school-logo { height: 35px; flex-shrink: 0; padding: 0; }
            .school-info h1 { font-size: 1rem; line-height: 1.2; }
            .question-text { font-size: 1.3rem; }
            .option-btn { font-size: 1rem; padding: 12px; }
            .game-container { padding: 15px; width: 100%; }
            .staff-grid { gap: 5px; }
            .staff-member { padding: 5px 2px; min-width: 0; }
            .staff-member .title { font-size: 0.7rem; }
            .staff-member .name { font-size: 0.7rem; line-height: 1.1; }
            .media-dept { font-size: 0.8rem; padding: 5px 15px; }
        }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-20px);} 60% {transform: translateY(-10px);} }
    </style>
</head>
<body>

    <div id="info-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ</h2>
            <label for="student-name">Ø§Ù„Ø§Ø³Ù…:</label>
            <input type="text" id="student-name" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" required>
            <label for="student-class">Ø§Ù„ÙØµÙ„:</label>
            <select id="student-class" required>
                <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„</option>
                <option value="2 / 1 Ø¨">2 / 1 Ø¨</option>
                <option value="2 / 2 Ø¨">2 / 2 Ø¨</option>
            </select>
            <button class="start-btn" onclick="submitInfo()">Ù‡ÙŠØ§ Ù†ØªØ¹Ù„Ù…</button>
        </div>
    </div>

    <div id="main-content">
        <header>
            <div class="school-info">
                <h1>Ø§Ù„Ø¥Ø¹Ù„Ø§Ù… Ø§Ù„ØªØ±Ø¨ÙˆÙŠ</h1>
            </div>
            <img src="logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©" class="school-logo" onerror="this.style.display='none'">
        </header>

        <div class="game-container">
            <div class="quiz-controls">
                <button class="mute-btn" id="mute-toggle" onclick="toggleMute()" title="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø£ØµÙˆØ§Øª">ğŸ”Š</button>
                <div class="progress-section">
                    <div class="progress-wrapper">
                        <span id="score-current" style="color:var(--success-color)">0</span> 
                        <span id="score-total" style="color:#888">0</span>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" id="progress-bar"></div>
                    </div>
                </div>
            </div>
            <div id="quiz-view">
                <button class="speak-btn" onclick="speakQuestion()">
                    <span>ğŸ—£ï¸</span> <span>Ø§Ù‚Ø±Ø£ Ù„ÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„</span>
                </button>
                <div class="question-text" id="question-text">...</div>
                <div class="options-grid" id="options-container"></div>
                <div class="feedback-msg" id="feedback"></div>
            </div>

            <div id="end-view" class="end-screen">
                <div class="trophy">ğŸ†</div>
                <h1 style="color: #4CAF50;">ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ ØªØ¹Ù„Ù…Øª ÙƒÙ„ Ø´ÙŠØ¡</h1>
                <p>Ø£Ù†Øª Ø·Ø§Ù„Ø¨ Ù…ØªÙ…ÙŠØ².</p>
                
                <div id="error-summary-container" style="margin-top: 30px; text-align: right; border-top: 2px solid #ddd; padding-top: 20px;">
                    <h2 style="color: #D32F2F; text-align: center;">ğŸš« Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:</h2>
                    <ul id="error-summary-list" style="list-style-type: none; padding: 0;"></ul>
                </div>

                <button class="option-btn" onclick="downloadReportImage()" style="background:#5C6BC0; color:white; margin-top:20px; margin-bottom: 10px;">
                    ğŸ“¸ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ 
                </button>
                <button class="option-btn" onclick="location.reload()" style="background:#0288D1; color:white; margin-top:0;">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ…Ø±ÙŠÙ†</button>
            </div>
        </div>

        <footer>
            <div class="footer-section">
                <div class="staff-grid">
                    <div class="staff-member"><p class="title">ÙˆÙƒÙŠÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</p><p class="name">Ø£/ ÙØ§Ø·Ù…Ø© Ø¬Ù…Ø§Ù„</p></div>
                    <div class="staff-member"><p class="title">ÙˆÙƒÙŠÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</p><p class="name">Ø£/ Ø¥ÙŠÙ…Ø§Ù† Ù…ØµØ·ÙÙ‰</p></div>
                    <div class="staff-member"><p class="title">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</p><p class="name">Ø£/ Ø¨Ù‡Ø§Ø¡ Ø§Ù„Ø¯ÙŠÙ† Ù…Ø­Ù…Ø¯</p></div>
                </div>
                <p class="media-dept">Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØªØµÙ…ÙŠÙ… Ø£Ø³Ø±Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù… Ø§Ù„ØªØ±Ø¨ÙˆÙŠ ğŸ“·</p>
            </div>
        </footer>
    </div>

    <audio id="sound-correct" src="https://www.soundjay.com/human/sounds/applause-01.mp3"></audio>
    <audio id="sound-wrong" src="https://www.soundjay.com/buttons/sounds/button-10.mp3"></audio>
    <audio id="sound-clapping" src="https://www.soundjay.com/human/sounds/applause-01.mp3"></audio>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
        let questionBank = [
            { text: "ØªØ·ÙŠØ± Ø§Ù„Ø·ÙŠÙˆØ± Ø§Ù„ØµØºÙŠØ±Ø© ÙÙˆØ± Ø®Ø±ÙˆØ¬Ù‡Ø§ Ù…Ù† Ø§Ù„Ø¨ÙŠØ¶.", type: "tf", options: ["ØµØ­", "Ø®Ø·Ø£"], correctIndex: 1 },
            { text: "Ù…Ø§ Ø£ÙØ¶Ù„ ØªØµØ±Ù Ø¥Ø°Ø§ Ø§Ø®ØªÙ„ÙØª Ù…Ø¹ Ø²Ù…ÙŠÙ„Ùƒ", type: "mcq", options: ["Ø§Ø¶Ø±Ø¨Ù‡", "Ø§ØµØ±Ø® ÙÙŠ ÙˆØ¬Ù‡Ù‡", "Ø§Ø­Ø§ÙˆÙ„ Ø§Ù„ØªÙØ§Ù‡Ù… Ù…Ø¹Ù‡"], correctIndex: 2 },
            { text: "Ø£ÙŠ Ù…Ù‡Ù†Ø© ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù…Ø¹Ø±ÙØ© ÙƒØ¨ÙŠØ±Ø© Ø¨Ø§Ù„Ø­Ø§Ø³Ø¨ Ø§Ù„Ø¢Ù„ÙŠ", type: "mcq", options: ["Ø§Ù„ÙÙ„Ø§Ø­", "Ù…Ù‡Ù†Ø¯Ø³ ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª", "Ø¹Ø§Ù…Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡"], correctIndex: 1 },
            { text: "ØªØ±ÙŠØ¯ Ù†ÙˆØ± Ù„Ø¹Ø¨ ÙƒØ±Ø© Ø§Ù„Ù‚Ø¯Ù… Ù„Ù…Ø¯Ø© 30 Ø¯Ù‚ÙŠÙ‚Ø© Ø«Ù… Ù‚ÙØ² Ø§Ù„Ø­Ø¨Ù„ Ù„Ù…Ø¯Ø© 5 Ø¯Ù‚Ø§Ø¦Ù‚ ØŒ ÙÙ…Ø§ Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬Ù‡Ø§ Ù†ÙˆØ± Ù„Ù„Ø¹Ø¨", type: "mcq", options: ["5", "35", " 30"], correctIndex: 1 },
            { text: "Ù„Ø¯ÙŠÙƒ 60 Ø¯Ù‚ÙŠÙ‚Ø© ÙˆÙ‚Øª ÙØ±Ø§Øº ØªØ±ÙŠØ¯ Ù„Ø¹Ø¨ 40 Ø¯Ù‚ÙŠÙ‚Ø© ÙÙ‚Ø· ØŒ ÙÙ…Ø§ Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù…Ù† ÙˆÙ‚Øª ÙØ±Ø§ØºÙƒ", type: "mcq", options: ["10", "15", " 20"], correctIndex: 2 },
            { text: "ØªØ®ØªÙ„Ù Ø§ØµÙˆØ§Øª Ø§Ù†Ø§Ø« Ø§Ù„Ø¥ÙˆØ² Ø§Ù„Ù…ØµØ±ÙŠ Ø¹Ù† Ø§ØµÙˆØ§Øª Ø§Ù„Ø°ÙƒÙˆØ±", type: "tf", options: ["ØµØ­", "Ø®Ø·Ø£"], correctIndex: 0 },
            { text: "ÙŠØ¨Ù„Øº Ø§Ø±ØªÙØ§Ø¹ Ø£Ø·ÙˆÙ„ Ø¬Ø¨Ù„ Ø¬Ù„ÙŠØ¯ÙŠ ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù… Ø­ÙˆØ§Ù„ÙŠ 55 Ø·Ø§Ø¨Ù‚ ÙÙˆÙ‚ Ø§Ù„Ù…Ø§Ø¡", type: "tf", options: ["ØµØ­", "Ø®Ø·Ø£"], correctIndex: 0 },
            { text: "ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ø§Ø¡ ÙÙŠ Ø«Ù„Ø§Ø« Ø­Ø§Ù„Ø§Øª ( ØµÙ„Ø¨Ø© - Ø³Ø§Ø¦Ù„Ø© - ØºØ§Ø²ÙŠØ© )", type: "tf", options: ["ØµØ­", "Ø®Ø·Ø£"], correctIndex: 0 }, 
            { text: "Ù…Ø§Ø°Ø§ Ø§Ù‚ØªØ±Ø­Øª ÙˆØ§Ù„Ø¯Ø© Ù†ÙˆØ± Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªØ£Ø®Ø± ÙÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ù…Ø§Ù… ØµØ¨Ø§Ø­Ø§", type: "mcq", options: ["Ø³Ù…Ø­Øª Ù„Ù‡Ù… Ø¨Ø§Ù„ØªØ£Ø®Ø± Ø¹Ù† Ø§Ù„Ù…Ø¯Ø±Ø³Ø©", "Ø·Ù„Ø¨Øª Ù…Ù†Ù‡Ù… Ø¶Ø¨Ø· Ø§Ù„Ù…Ø¤Ù‚Øª", "ØµØ±Ø®Øª ÙÙŠ Ø³Ø§Ø±Ø© Ù„Ø§Ù†Ù‡Ø§ ØªØªØ£Ø®Ø±"], correctIndex: 1 },
            { text: "ÙŠØ·Ù„Ù‚ Ø¹Ù„ÙŠ .... ØµØ¯ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§Ø­ ", type: "mcq", options: ["Ø§Ù„Ù‡Ø¯Ù‡Ø¯", "Ø§Ø¨Ùˆ Ù‚Ø±Ø¯Ø§Ù†", "Ø§Ù„Ø­Ù…Ø§Ø±"], correctIndex: 1 },
            { text: "ÙŠØ¬Ø¨ ØºØ³Ù„ Ø§Ù„ÙŠØ¯ÙŠÙ† Ù„Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø£Ù…Ø±Ø§Ø¶.", type: "tf", options: ["ØµØ­", "Ø®Ø·Ø£"], correctIndex: 0 },
            { text: "Ù…Ø§Ø°Ø§ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹Ø© ÙÙŠ Ù…ØªØ¬Ø± Ø§Ù„Ù…Ù„Ø§Ø¨Ø³ ØŸ", type: "mcq", options: ["Ø§Ù„Ù…Ø·Ø±Ù‚Ø©", "Ø§Ù„Ù…ÙŠÙƒØ±ÙˆØ³ÙƒÙˆØ¨", "Ø¢Ù„Ø© Ø§Ù„Ù†Ù‚ÙˆØ¯"], correctIndex: 2 },
            { text: "Ù…Ù† Ø£Ø¯ÙˆØ§Øª ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø®Ø¶Ø±ÙˆØ§Øª", type: "mcq", options: ["Ø§Ù„ØµØ§Ø¨ÙˆÙ†", "Ø§Ù„Ù…Ø§Ø¡", "Ø§Ù„Ø¹Ø·Ø±"], correctIndex: 1 },
            { text: "ØªØ¹ÙŠØ´ Ù†ÙˆØ± Ù…Ø¹ Ø£Ù…Ù‡Ø§ ÙˆØ£Ø¨ÙŠÙ‡Ø§ ÙÙ‚Ø·", type: "tf", options: ["ØµØ­", "Ø®Ø·Ø£"], correctIndex: 1 },
            { text: "Ø§Ù„ØªØ¹Ø§ÙˆÙ† ÙŠØ¹Ù†ÙŠ Ø£Ù† ÙŠØ¹Ù…Ù„ ÙƒÙ„ ÙØ±Ø¯ Ø¨Ù…ÙØ±Ø¯Ù‡ Ø¯ÙˆÙ† Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†", type: "tf", options: ["ØµØ­", "Ø®Ø·Ø£"], correctIndex: 1 },
            { text: "Ø§Ø°Ø§ ÙˆØ¶Ø¹Øª ÙƒØªØ§Ø¨Ø§ ØµØºÙŠØ±Ø§ Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† Ø¹ÙŠÙ†ÙŠÙƒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù† ØªØºØ·ÙŠ Ø¨Ù‡ Ø´Ø¬Ø±Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§ Ø¨Ø¹ÙŠØ¯Ø© Ø¹Ù†Ùƒ", type: "tf", options: ["ØµØ­", "Ø®Ø·Ø£"], correctIndex: 0 },
            { text: "Ù‚Ù„Ø© Ø§Ù„Ù†ÙˆÙ… ØªØ¬Ø¹Ù„ Ø§Ù„Ø¬Ø³Ù… Ø£ÙƒØ«Ø± ØµØ­Ø© ÙˆÙ‚ÙˆØ©", type: "tf", options: ["ØµØ­", "Ø®Ø·Ø£"], correctIndex: 1 },
            { text: "Ù…Ù…Ø§Ø±Ø³Ø© Ø§Ù„Ø±ÙŠØ§Ø¶Ø© ØªØ³Ø§Ø¹Ø¯ Ø¹Ù„Ù‰ ØµØ­Ø© Ø§Ù„Ø¬Ø³Ù… ÙˆØ§Ù„Ø¹Ù‚Ù„", type: "tf", options: ["ØµØ­", "Ø®Ø·Ø£"], correctIndex: 0 },
            { text: "Ø¥Ù‡Ù…Ø§Ù„ Ø§Ù„Ø·Ø¹Ø§Ù… Ø§Ù„ØµØ­ÙŠ ÙŠØ³Ø¨Ø¨ Ø²ÙŠØ§Ø±Ø© ÙƒØ«ÙŠØ±Ø© Ù„Ù„Ø£Ø·Ø¨Ø§Ø¡", type: "tf", options: ["ØµØ­", "Ø®Ø·Ø£"], correctIndex: 0 },
            { text: "Ø¹Ù†Ø¯Ù…Ø§ ØªØ±Ù‰ Ø·Ø§Ø¦Ø±Ø© ØªØ­Ù„Ù‘Ù‚ Ø¹Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø³Ù…Ø§Ø¡ØŒ ØªØ¨Ø¯Ùˆ Ù„Ùƒ ØµØºÙŠØ±Ø© Ø§Ù„Ø­Ø¬Ù…", type: "tf", options: ["ØµØ­", "Ø®Ø·Ø£"], correctIndex: 0 },
            { text: "ÙˆØ§Ù„Ø¯ Ù†ÙˆØ± ÙŠØ¹Ù…Ù„ Ù…Ù‡Ù†Ø¯Ø³Ù‹Ø§ ÙÙŠ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±", type: "tf", options: ["ØµØ­", "Ø®Ø·Ø£"], correctIndex: 1 }, 
            { text: "ØµØºØ§Ø± Ø§Ù„Ø·ÙŠÙˆØ± ØªØ¹ÙŠØ´ ÙÙŠ", type: "mcq", options: ["Ø§Ù„ÙƒÙ‡Ù", "  Ø§Ù„Ø­Ø¬Ø±", "Ø§Ù„Ø¹Ø´ "], correctIndex: 2 },
            { text: "Ù…Ø§ Ù‡Ùˆ Ø¹Ù…Ù„ ÙˆØ§Ù„Ø¯ Ù†ÙˆØ±", type: "mcq", options: ["Ù…Ù‡Ù†Ø¯Ø³", "  Ø·Ø¨ÙŠØ¨", "Ø¹Ø§Ù…Ù„ Ø¨Ù†Ø§Ø¡ "], correctIndex: 2 },
            { text: "ØªØ¹ØªØ¨Ø± Ù…ÙŠØ§Ù‡ Ù†Ù‡Ø± Ø§Ù„Ù†ÙŠÙ„ Ù…ÙŠØ§Ù‡ ....", type: "mcq", options: ["Ø®Ù„ÙŠØ· Ø¹Ø°Ø¨ ÙˆÙ…Ø§Ù„Ø­", "  Ù…Ø§Ù„Ø­Ø©", "Ø¹Ø°Ø¨Ø© "], correctIndex: 2 },
            { text: "Ù…Ø§Ø°Ø§ ÙŠØ­Ø¯Ø« Ù„ØµØºØ§Ø± Ø§Ù„Ø·ÙŠÙˆØ± Ø¨Ø¹Ø¯ Ø®Ø±ÙˆØ¬Ù‡Ø§ Ù…Ù† Ø§Ù„Ø¨ÙŠØ¶", type: "mcq", options: ["ØªØ·ÙŠØ± ÙÙˆØ±Ù‹Ø§", "  ØªØ¨Ù‚Ù‰ ÙÙŠ Ø§Ù„Ø¹Ø´ ÙˆØªØ±Ø¹Ø§Ù‡Ø§ Ø§Ù„Ø£Ù…", " ØªØ°Ù‡Ø¨ ÙˆØ­Ø¯Ù‡Ø§ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ø¹Ø§Ù… "], correctIndex: 1 },
            { text: "Ù…Ø§ Ù‡ÙŠ ÙˆØ¸ÙŠÙØ© Ø£Ù… Ù†ÙˆØ± ÙÙŠ Ø§Ù„ÙÙ†Ø¯Ù‚", type: "mcq", options: ["Ù…ÙˆØ¸ÙØ© Ø§Ø³ØªÙ‚Ø¨Ø§Ù„", "  Ø¹Ø§Ù…Ù„Ø© Ù†Ø¸Ø§ÙØ©", "Ù…Ø±Ø´Ø¯Ø© Ø³ÙŠØ§Ø­ÙŠØ©  "], correctIndex: 0 } 
        ];
        questionBank = questionBank.map(q => ({...q, errorCount: 0}));

        let questionQueue = [...questionBank]; 
        let totalQuestionsCount = questionBank.length;
        let masteredCount = 0;
        let isProcessing = false;
        let isMuted = false;
        let studentName = "";
        let studentClass = "";

        function submitInfo() {
            const nameInput = document.getElementById('student-name');
            const classSelect = document.getElementById('student-class');
            if (nameInput.value.trim() === "" || classSelect.value === "") { alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØµÙ„ Ø£ÙˆÙ„Ø§Ù‹."); return; }
            studentName = nameInput.value.trim();
            studentClass = classSelect.value;
            document.getElementById('info-modal').style.display = 'none';
            document.getElementById('main-content').style.display = 'flex';
            document.getElementById('score-total').innerText = totalQuestionsCount;
            loadQuestion();
        }

        function toggleMute() {
            isMuted = !isMuted;
            const btn = document.getElementById('mute-toggle');
            if (isMuted) { btn.innerHTML = "ğŸ”‡"; btn.classList.add('muted'); window.speechSynthesis.cancel(); }
            else { btn.innerHTML = "ğŸ”Š"; btn.classList.remove('muted'); }
        }

        function loadQuestion() {
            if (questionQueue.length === 0) { showEndScreen(); return; }
            isProcessing = false;
            const currentQ = questionQueue[0];
            document.getElementById('question-text').innerText = currentQ.text;
            document.getElementById('feedback').innerText = "";
            document.getElementById('score-current').innerText = masteredCount;
            document.getElementById('progress-bar').style.width = (masteredCount / totalQuestionsCount * 100) + "%";
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            currentQ.options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(index, btn);
                optionsContainer.appendChild(btn);
            });
        }

        function checkAnswer(selectedIndex, btnElement) {
            if (isProcessing) return;
            isProcessing = true;
            const currentQ = questionQueue[0];
            const isCorrect = selectedIndex === currentQ.correctIndex;
            const optionsDivs = document.getElementById('options-container').children;

            if (isCorrect) {
                btnElement.classList.add('correct');
                document.getElementById('feedback').innerHTML = "<span style='color:green'>Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! Ø£Ø­Ø³Ù†Øª ğŸ‘</span>";
                playAudio('correct'); 
                setTimeout(() => { masteredCount++; questionQueue.shift(); loadQuestion(); }, 1500); 
            } else {
                const originalQuestion = questionBank.find(q => q.text === currentQ.text);
                if (originalQuestion) originalQuestion.errorCount++;
                btnElement.classList.add('wrong');
                optionsDivs[currentQ.correctIndex].classList.add('correct'); 
                const correctText = currentQ.options[currentQ.correctIndex];
                document.getElementById('feedback').innerHTML = `<span style='color:red'>Ø®Ø·Ø£! Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù‡ÙŠ: ${correctText}</span>`;
                playAudio('wrong');
                setTimeout(() => { const missedQuestion = questionQueue.shift(); questionQueue.push(missedQuestion); loadQuestion(); }, 3000);
            }
        }

        function playAudio(type) {
            if (isMuted) return; 
            const audioId = type === 'correct' ? 'sound-correct' : type === 'wrong' ? 'sound-wrong' : 'sound-clapping';
            const audio = document.getElementById(audioId);
            if(audio) { audio.currentTime = 0; audio.play().catch(() => {}); }
        }

        function speakQuestion() {
            if (isMuted) { alert("ÙŠØ±Ø¬Ù‰ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø£ÙˆÙ„Ø§Ù‹."); return; }
            if (questionQueue.length > 0) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(questionQueue[0].text);
                utterance.lang = 'ar-EG'; utterance.rate = 0.85; 
                window.speechSynthesis.speak(utterance);
            }
        }

        function showEndScreen() {
            document.getElementById('quiz-view').style.display = 'none';
            document.getElementById('end-view').style.display = 'block';
            document.getElementById('progress-bar').style.width = "100%";
            document.getElementById('score-current').innerText = totalQuestionsCount;
            playAudio('clapping'); 
            
            const endViewElement = document.getElementById('end-view');
            const oldInfo = endViewElement.querySelector('.student-info-report');
            if (oldInfo) oldInfo.remove();
            
            const studentInfoHTML = `
                <div class="student-info-report" style="background: #E0F7FA; border: 2px solid var(--primary-color); padding: 15px; margin-bottom: 25px; border-radius: 10px; text-align: center;">
                    <h3 style="color: var(--primary-color); margin: 0 0 5px 0;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨:</h3>
                    <p style="margin: 0; font-size: 1.2rem; font-weight: bold; color: #333;">Ø§Ù„Ø§Ø³Ù…: ${studentName}</p>
                    <p style="margin: 5px 0 0 0; font-size: 1.1rem; color: #555;">Ø§Ù„ÙØµÙ„: ${studentClass}</p>
                </div>
            `;
            endViewElement.querySelector('.trophy').insertAdjacentHTML('afterend', studentInfoHTML);

            const summaryList = document.getElementById('error-summary-list');
            summaryList.innerHTML = ''; 
            const erroredQuestions = questionBank.filter(q => q.errorCount > 0);
            const summaryContainer = document.getElementById('error-summary-container');

            if (erroredQuestions.length > 0) {
                summaryContainer.innerHTML = `<h2 style="color: #D32F2F; text-align: center;">ğŸš« Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:</h2><ul id="error-summary-list" style="list-style-type: none; padding: 0;"></ul>`;
                const newSummaryList = document.getElementById('error-summary-list');
                erroredQuestions.forEach(q => {
                    newSummaryList.innerHTML += `<li style="margin-bottom:10px;"><div style="background: #FFF8E1; border: 1px solid #FFE0B2; padding: 10px; border-radius: 8px; text-align: right;"><p style="margin: 0; font-weight: bold; color: #E65100;">Ø§Ù„Ø³Ø¤Ø§Ù„: ${q.text}</p><p style="margin: 5px 0 0 0; color: #4CAF50;">âœ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ${q.options[q.correctIndex]}</p><p style="margin: 5px 0 0 0; font-size: 0.9em; color: #D32F2F;">âŒ Ù…Ø±Ø§Øª Ø§Ù„Ø®Ø·Ø£: ${q.errorCount}</p></div></li>`;
                });
            } else {
                summaryContainer.innerHTML = `<h2 style="color: #4CAF50; text-align: center; border-top: 2px solid #ddd; padding-top: 20px;">ğŸ‰ Ø£Ø­Ø³Ù†Øª! Ù„Ù… ØªØ®Ø·Ø¦ ÙÙŠ Ø£ÙŠ Ø³Ø¤Ø§Ù„.</h2>`;
            }

            // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµØ§Ù…Øª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ©
            setTimeout(autoSendReportSilently, 1000);
        }

        function dataURItoBlob(dataURI) {
            var byteString = atob(dataURI.split(',')[1]);
            var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
            var ab = new ArrayBuffer(byteString.length);
            var ia = new Uint8Array(ab);
            for (var i = 0; i < byteString.length; i++) { ia[i] = byteString.charCodeAt(i); }
            return new Blob([ab], {type: mimeString});
        }

        // --- Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµØ§Ù…Øª (Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„Ø·Ø§Ù„Ø¨) ---
        function autoSendReportSilently() {
            const element = document.getElementById('end-view');
            // Ù†Ø®ÙÙŠ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙ‚Ø· Ù„Ø£Ø®Ø° Ø§Ù„Ù„Ù‚Ø·Ø©
            const buttonsToHide = element.querySelectorAll('.option-btn');
            buttonsToHide.forEach(b => b.style.display = 'none');

            const originalMaxHeight = element.style.maxHeight;
            const originalOverflowY = element.style.overflowY;
            element.style.maxHeight = 'initial';
            element.style.overflowY = 'visible';

            // Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©
            html2canvas(element, { scale: 1.5, backgroundColor: '#ffffff' }).then(canvas => {
                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ø¸Ù‡ÙˆØ± ÙÙˆØ±Ø§Ù‹
                element.style.maxHeight = originalMaxHeight;
                element.style.overflowY = originalOverflowY;
                buttonsToHide.forEach(b => b.style.display = 'block');

                const imageBlob = dataURItoBlob(canvas.toDataURL('image/png'));
                const formData = new FormData();
                const targetEmail = "salah44eldin@gmail.com"; 

                // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„
                formData.append("_captcha", "false");
                formData.append("_subject", `ØªÙ‚Ø±ÙŠØ± Ø·Ø§Ù„Ø¨: ${studentName} - Ø§Ù„ÙØµÙ„ ${studentClass}`);
                formData.append("_template", "table");
                formData.append("Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨", studentName);
                formData.append("Ø§Ù„ÙØµÙ„", studentClass);
                formData.append("Ø§Ù„Ø¯Ø±Ø¬Ø©", `${totalQuestionsCount} / ${totalQuestionsCount}`);
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±Ø© ÙƒÙ…Ù„Ù Ù…Ø±ÙÙ‚
                formData.append("ØµÙˆØ±Ø©_Ø§Ù„ØªÙ‚Ø±ÙŠØ±", imageBlob, `Report-${studentName}.png`);

                // Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© (Ø¨Ø¯ÙˆÙ† ØªÙ†Ø¨ÙŠÙ‡Ø§Øª)
                fetch(`https://formsubmit.co/${targetEmail}`, {
                    method: "POST",
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        console.log("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ù…Ø¹Ù„Ù… ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¨Ù†Ø¬Ø§Ø­.");
                    } else {
                        console.log("ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµØ§Ù…Øª.");
                    }
                })
                .catch(error => {
                    console.log("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµØ§Ù…Øª.");
                });
            }).catch(err => {
                // ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ Ø§Ù„ØªØµÙˆÙŠØ±ØŒ Ù†Ø¹ÙŠØ¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙ‚Ø·
                element.style.maxHeight = originalMaxHeight;
                element.style.overflowY = originalOverflowY;
                buttonsToHide.forEach(b => b.style.display = 'block');
                console.log("ÙØ´Ù„ Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø¥Ø±Ø³Ø§Ù„.");
            });
        }

        function downloadReportImage() {
            const element = document.getElementById('end-view');
            const buttonsToHide = element.querySelectorAll('.option-btn');
            
            buttonsToHide.forEach(btn => btn.style.display = 'none');
            
            const originalMaxHeight = element.style.maxHeight;
            const originalOverflowY = element.style.overflowY;
            element.style.maxHeight = 'initial';
            element.style.overflowY = 'visible';

            html2canvas(element, { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
                const a = document.createElement('a');
                a.href = canvas.toDataURL('image/png');
                a.download = `ØªÙ‚Ø±ÙŠØ±_${studentName}_Ù…Ø±Ø§Ø¬Ø¹Ø©.png`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                
                element.style.maxHeight = originalMaxHeight;
                element.style.overflowY = originalOverflowY;
                buttonsToHide.forEach(btn => btn.style.display = 'block');
                alert("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­ ");
            });
        }

        window.onload = function() { document.getElementById('info-modal').style.display = 'flex'; };
    </script>
</body>

</html>

